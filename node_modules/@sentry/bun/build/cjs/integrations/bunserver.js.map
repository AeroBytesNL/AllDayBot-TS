{"version":3,"file":"bunserver.js","sources":["../../../src/integrations/bunserver.ts"],"sourcesContent":["import type { IntegrationFn, RequestEventData, SpanAttributes } from '@sentry/core';\nimport {\n  SEMANTIC_ATTRIBUTE_HTTP_REQUEST_METHOD,\n  SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n  SEMANTIC_ATTRIBUTE_SENTRY_SOURCE,\n  captureException,\n  continueTrace,\n  defineIntegration,\n  extractQueryParamsFromUrl,\n  getSanitizedUrlString,\n  parseUrl,\n  setHttpStatus,\n  startSpan,\n  withIsolationScope,\n} from '@sentry/core';\n\nconst INTEGRATION_NAME = 'BunServer';\n\nconst _bunServerIntegration = (() => {\n  return {\n    name: INTEGRATION_NAME,\n    setupOnce() {\n      instrumentBunServe();\n    },\n  };\n}) satisfies IntegrationFn;\n\n/**\n * Instruments `Bun.serve` to automatically create transactions and capture errors.\n *\n * Enabled by default in the Bun SDK.\n *\n * ```js\n * Sentry.init({\n *   integrations: [\n *     Sentry.bunServerIntegration(),\n *   ],\n * })\n * ```\n */\nexport const bunServerIntegration = defineIntegration(_bunServerIntegration);\n\n/**\n * Instruments Bun.serve by patching it's options.\n */\nexport function instrumentBunServe(): void {\n  Bun.serve = new Proxy(Bun.serve, {\n    apply(serveTarget, serveThisArg, serveArgs: Parameters<typeof Bun.serve>) {\n      instrumentBunServeOptions(serveArgs[0]);\n      const server: ReturnType<typeof Bun.serve> = serveTarget.apply(serveThisArg, serveArgs);\n\n      // A Bun server can be reloaded, re-wrap any fetch function passed to it\n      // We can't use a Proxy for this as Bun does `instanceof` checks internally that fail if we\n      // wrap the Server instance.\n      const originalReload: typeof server.reload = server.reload.bind(server);\n      server.reload = (serveOptions: Parameters<typeof Bun.serve>[0]) => {\n        instrumentBunServeOptions(serveOptions);\n        return originalReload(serveOptions);\n      };\n\n      return server;\n    },\n  });\n}\n\n/**\n * Instruments Bun.serve `fetch` option to automatically create spans and capture errors.\n */\nfunction instrumentBunServeOptions(serveOptions: Parameters<typeof Bun.serve>[0]): void {\n  serveOptions.fetch = new Proxy(serveOptions.fetch, {\n    apply(fetchTarget, fetchThisArg, fetchArgs: Parameters<typeof serveOptions.fetch>) {\n      return withIsolationScope(isolationScope => {\n        const request = fetchArgs[0];\n        const upperCaseMethod = request.method.toUpperCase();\n        if (upperCaseMethod === 'OPTIONS' || upperCaseMethod === 'HEAD') {\n          return fetchTarget.apply(fetchThisArg, fetchArgs);\n        }\n\n        const parsedUrl = parseUrl(request.url);\n        const attributes: SpanAttributes = {\n          [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.http.bun.serve',\n          [SEMANTIC_ATTRIBUTE_HTTP_REQUEST_METHOD]: request.method || 'GET',\n          [SEMANTIC_ATTRIBUTE_SENTRY_SOURCE]: 'url',\n        };\n        if (parsedUrl.search) {\n          attributes['http.query'] = parsedUrl.search;\n        }\n\n        const url = getSanitizedUrlString(parsedUrl);\n\n        isolationScope.setSDKProcessingMetadata({\n          normalizedRequest: {\n            url,\n            method: request.method,\n            headers: request.headers.toJSON(),\n            query_string: extractQueryParamsFromUrl(url),\n          } satisfies RequestEventData,\n        });\n\n        return continueTrace(\n          { sentryTrace: request.headers.get('sentry-trace') || '', baggage: request.headers.get('baggage') },\n          () => {\n            return startSpan(\n              {\n                attributes,\n                op: 'http.server',\n                name: `${request.method} ${parsedUrl.path || '/'}`,\n              },\n              async span => {\n                try {\n                  const response = await (fetchTarget.apply(fetchThisArg, fetchArgs) as ReturnType<\n                    typeof serveOptions.fetch\n                  >);\n                  if (response && response.status) {\n                    setHttpStatus(span, response.status);\n                    isolationScope.setContext('response', {\n                      headers: response.headers.toJSON(),\n                      status_code: response.status,\n                    });\n                  }\n                  return response;\n                } catch (e) {\n                  captureException(e, {\n                    mechanism: {\n                      type: 'bun',\n                      handled: false,\n                      data: {\n                        function: 'serve',\n                      },\n                    },\n                  });\n                  throw e;\n                }\n              },\n            );\n          },\n        );\n      });\n    },\n  });\n}\n"],"names":["defineIntegration","withIsolationScope","parseUrl","SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN","SEMANTIC_ATTRIBUTE_HTTP_REQUEST_METHOD","SEMANTIC_ATTRIBUTE_SENTRY_SOURCE","getSanitizedUrlString","extractQueryParamsFromUrl","continueTrace","startSpan","setHttpStatus","captureException"],"mappings":"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"}